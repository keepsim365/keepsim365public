import boto3
import datetime
import json

# Initialize the CloudTrail client
client = boto3.client('cloudtrail')

# Set the date range for the past month
end_time = datetime.datetime.now()
start_time = end_time - datetime.timedelta(days=30)

# Set your AWS region
aws_region = 'eu-west-2'

# Define the log file name
log_file_name = 'duplicate_resource_exceptions.log'

# Query CloudTrail events for "AssociateUserProficiencies" in the last month
response = client.lookup_events(
    LookupAttributes=[
        {
            'AttributeKey': 'EventName',
            'AttributeValue': 'AssociateUserProficiencies'
        }
    ],
    StartTime=start_time,
    EndTime=end_time,
    MaxResults=50
)

# Open the log file to write the results
with open(log_file_name, 'w') as log_file:
    for event in response['Events']:
        cloudtrail_event = json.loads(event['CloudTrailEvent'])
        
        # Check if the error "DuplicateResourceException" exists in the event
        if 'errorCode' in cloudtrail_event and cloudtrail_event['errorCode'] == 'DuplicateResourceException':
            log_data = {
                "Event ID": event['EventId'],
                "Event Name": event['EventName'],
                "Event Time": str(event['EventTime']),
                "Username": event['Username'],
                "Error Code": cloudtrail_event['errorCode'],
                "Error Message": cloudtrail_event.get('errorMessage', 'No error message'),
                "CloudTrail Event": cloudtrail_event
            }
            
            # Write the event details to the log file
            log_file.write(json.dumps(log_data, indent=4))
            log_file.write('\n' + '-' * 60 + '\n')

print(f"Log file written: {log_file_name}")
